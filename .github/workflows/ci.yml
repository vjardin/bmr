name: bmr CI
run-name: ${{ github.actor }} build matrix

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-bmr:
    name: bmr ${{ matrix.compiler }} / ${{ matrix.arch }} / ${{ matrix.build_mode }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
        arch: [ x86_64, arm64 ]
        compiler: [ gcc, clang ]
        build_mode: [ normal, static_libs ]
    env:
      MESON_BUILD_DIR: build
    steps:
      - uses: actions/checkout@v4

      - name: Install packages (Meson + deps)
        uses: ConorMacBride/install-package@v1
        with:
          apt: >-
            meson ninja-build pkg-config
            clang
            build-essential
            libjansson-dev
            i2c-tools
            libi2c-dev

      - name: Set default compiler (env)
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            echo "CC=gcc" >> $GITHUB_ENV
          else
            echo "CC=clang" >> $GITHUB_ENV
          fi
          echo "CFLAGS=-O2 -Wall -Wextra" >> $GITHUB_ENV

      - name: Meson setup
        run: |
          rm -rf "${MESON_BUILD_DIR}"
          if [ "${{ matrix.build_mode }}" = "static_libs" ]; then
            meson setup "${MESON_BUILD_DIR}" -Dfully_static=true
          else
            meson setup "${MESON_BUILD_DIR}" -Dfully_static=false
          fi

      - name: Compile
        run: meson compile -C "${MESON_BUILD_DIR}" -v

      - name: Verify binary and link composition
        run: |
          file "${MESON_BUILD_DIR}/src/bmr" || exit 1
          ldd "${MESON_BUILD_DIR}/src/bmr" || true
          "${MESON_BUILD_DIR}/src/bmr" --help || true

      - uses: actions/upload-artifact@v4
        with:
          name: bmr-${{ matrix.compiler }}-${{ matrix.arch }}-${{ matrix.build_mode }}-${{ matrix.os }}
          path: ${{ env.MESON_BUILD_DIR }}/src/bmr
